<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bifrost Client Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { font-size: 24px; font-weight: 600; }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status-connected { background: #22c55e; color: #052e16; }
        .status-disconnected { background: #ef4444; color: #450a0a; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #334155;
        }
        .card h3 { font-size: 12px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .card .value { font-size: 28px; font-weight: 600; color: #f1f5f9; }
        .section { margin-bottom: 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 18px; font-weight: 600; color: #f1f5f9; }
        .traffic-list { background: #1e293b; border-radius: 12px; border: 1px solid #334155; overflow: hidden; }
        .traffic-item {
            padding: 12px 16px;
            border-bottom: 1px solid #334155;
            display: grid;
            grid-template-columns: 80px 60px 1fr 80px 80px 80px;
            gap: 12px;
            align-items: center;
            font-size: 13px;
        }
        .traffic-item:last-child { border-bottom: none; }
        .traffic-item:hover { background: #334155; }
        .traffic-header {
            background: #0f172a;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            font-size: 11px;
        }
        .method { font-weight: 600; }
        .method-GET { color: #22c55e; }
        .method-POST { color: #3b82f6; }
        .method-PUT { color: #f59e0b; }
        .method-DELETE { color: #ef4444; }
        .method-CONNECT { color: #8b5cf6; }
        .status { font-weight: 500; }
        .status-2xx { color: #22c55e; }
        .status-3xx { color: #3b82f6; }
        .status-4xx { color: #f59e0b; }
        .status-5xx { color: #ef4444; }
        .host { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .route { font-size: 11px; padding: 2px 6px; border-radius: 4px; }
        .route-server { background: #3b82f6; color: white; }
        .route-direct { background: #22c55e; color: white; }
        .nav { display: flex; gap: 8px; margin-bottom: 24px; }
        .nav button {
            padding: 10px 20px;
            background: #334155;
            border: none;
            border-radius: 8px;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .nav button:hover { background: #475569; }
        .nav button.active { background: #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-group { display: flex; gap: 8px; }
        .filter-input {
            padding: 8px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 14px;
            width: 200px;
        }
        .filter-input:focus { outline: none; border-color: #3b82f6; }
        #error-message {
            background: #7f1d1d;
            color: #fca5a5;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Bifrost Client</h1>
                <p style="color: #64748b; font-size: 14px; margin-top: 4px;" id="version">Loading...</p>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <span>Server:</span>
                <span id="server-status" class="status-badge status-disconnected">Disconnected</span>
                <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
            </div>
        </header>

        <div id="error-message"></div>

        <nav class="nav">
            <button class="active" onclick="showTab('traffic')">Traffic</button>
            <button onclick="showTab('routes')">Routes</button>
        </nav>

        <div id="traffic" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>Total Requests</h3>
                    <div class="value" id="total-requests">-</div>
                </div>
                <div class="card">
                    <h3>Via Server</h3>
                    <div class="value" id="server-requests">-</div>
                </div>
                <div class="card">
                    <h3>Direct</h3>
                    <div class="value" id="direct-requests">-</div>
                </div>
                <div class="card">
                    <h3>Errors</h3>
                    <div class="value" id="error-count">-</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Recent Traffic</h2>
                    <div class="btn-group">
                        <input type="text" id="filter-input" class="filter-input" placeholder="Filter by host...">
                        <button class="btn btn-danger" onclick="clearTraffic()">Clear</button>
                    </div>
                </div>
                <div class="traffic-list">
                    <div class="traffic-item traffic-header">
                        <div>Time</div>
                        <div>Method</div>
                        <div>Host</div>
                        <div>Status</div>
                        <div>Duration</div>
                        <div>Route</div>
                    </div>
                    <div id="traffic-entries">
                        <div class="empty-state">Loading traffic...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="routes" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Routing Rules</h2>
                    <div class="btn-group">
                        <input type="text" id="test-domain" class="filter-input" placeholder="Test domain...">
                        <button class="btn btn-primary" onclick="testRoute()">Test</button>
                    </div>
                </div>
                <div id="test-result" style="margin-bottom: 16px; display: none;"></div>
                <div class="traffic-list">
                    <div class="traffic-item traffic-header">
                        <div style="grid-column: span 2;">Name</div>
                        <div style="grid-column: span 2;">Patterns</div>
                        <div>Action</div>
                        <div>Priority</div>
                    </div>
                    <div id="routes-list">
                        <div class="empty-state">Loading routes...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/v1';
        let refreshInterval;
        let filterText = '';

        async function fetchJSON(path) {
            const resp = await fetch(API_BASE + path);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            return resp.json();
        }

        function formatTime(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('en-US', { hour12: false });
            } catch {
                return '-';
            }
        }

        function getMethodClass(method) {
            return `method method-${method}`;
        }

        function getStatusClass(status) {
            if (status >= 200 && status < 300) return 'status status-2xx';
            if (status >= 300 && status < 400) return 'status status-3xx';
            if (status >= 400 && status < 500) return 'status status-4xx';
            return 'status status-5xx';
        }

        async function refreshData() {
            try {
                // Fetch status
                const status = await fetchJSON('/status');
                document.getElementById('version').textContent = `v${status.version || 'unknown'}`;

                const serverBadge = document.getElementById('server-status');
                if (status.server_status === 'connected') {
                    serverBadge.className = 'status-badge status-connected';
                    serverBadge.textContent = 'Connected';
                } else {
                    serverBadge.className = 'status-badge status-disconnected';
                    serverBadge.textContent = 'Disconnected';
                }

                document.getElementById('total-requests').textContent = status.debug_entries || 0;

                // Fetch traffic entries
                const entries = await fetchJSON('/debug/entries/last/50');
                renderTraffic(entries);

                // Fetch routes
                const routes = await fetchJSON('/routes');
                renderRoutes(routes);

                document.getElementById('error-message').style.display = 'none';
            } catch (err) {
                document.getElementById('error-message').textContent = 'Failed to fetch data: ' + err.message;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        function renderTraffic(entries) {
            const container = document.getElementById('traffic-entries');

            if (!entries || entries.length === 0) {
                container.innerHTML = '<div class="empty-state">No traffic recorded</div>';
                return;
            }

            let serverCount = 0;
            let directCount = 0;
            let errorCount = 0;

            const filtered = entries.filter(e => {
                if (!filterText) return true;
                return (e.host || '').toLowerCase().includes(filterText.toLowerCase());
            });

            entries.forEach(e => {
                if (e.route === 'server') serverCount++;
                else directCount++;
                if (e.error) errorCount++;
            });

            document.getElementById('server-requests').textContent = serverCount;
            document.getElementById('direct-requests').textContent = directCount;
            document.getElementById('error-count').textContent = errorCount;

            container.innerHTML = filtered.map(e => `
                <div class="traffic-item">
                    <div>${formatTime(e.timestamp)}</div>
                    <div class="${getMethodClass(e.method)}">${e.method || '-'}</div>
                    <div class="host" title="${e.host}">${e.host || '-'}</div>
                    <div class="${getStatusClass(e.status_code)}">${e.status_code || '-'}</div>
                    <div>${e.duration_ms ? e.duration_ms + 'ms' : '-'}</div>
                    <div><span class="route route-${e.route || 'server'}">${e.route || 'server'}</span></div>
                </div>
            `).join('');
        }

        function renderRoutes(routes) {
            const container = document.getElementById('routes-list');

            if (!routes || routes.length === 0) {
                container.innerHTML = '<div class="empty-state">No routes configured</div>';
                return;
            }

            container.innerHTML = routes.map(r => `
                <div class="traffic-item">
                    <div style="grid-column: span 2;">${r.name || '-'}</div>
                    <div style="grid-column: span 2;">${Array.isArray(r.patterns) ? r.patterns.join(', ') : r.patterns}</div>
                    <div><span class="route route-${r.action}">${r.action}</span></div>
                    <div>${r.priority}</div>
                </div>
            `).join('');
        }

        async function clearTraffic() {
            try {
                await fetch(API_BASE + '/debug/entries', { method: 'DELETE' });
                refreshData();
            } catch (err) {
                alert('Failed to clear: ' + err.message);
            }
        }

        async function testRoute() {
            const domain = document.getElementById('test-domain').value;
            if (!domain) return;

            try {
                const result = await fetchJSON('/routes/test?domain=' + encodeURIComponent(domain));
                const resultDiv = document.getElementById('test-result');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="card">
                        <strong>${result.domain}</strong> will be routed via
                        <span class="route route-${result.action}">${result.action}</span>
                    </div>
                `;
            } catch (err) {
                alert('Test failed: ' + err.message);
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        document.getElementById('filter-input').addEventListener('input', (e) => {
            filterText = e.target.value;
            refreshData();
        });

        // Initial load and refresh
        refreshData();
        refreshInterval = setInterval(refreshData, 3000);
    </script>
</body>
</html>
