<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bifrost Server Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { font-size: 24px; font-weight: 600; }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status-healthy { background: #22c55e; color: #052e16; }
        .status-unhealthy { background: #ef4444; color: #450a0a; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }
        .card h3 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .card .value { font-size: 32px; font-weight: 600; color: #f1f5f9; }
        .card .subtext { font-size: 12px; color: #64748b; margin-top: 4px; }
        .section { margin-bottom: 24px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #f1f5f9; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #334155; }
        th { font-size: 12px; text-transform: uppercase; color: #64748b; font-weight: 500; }
        td { font-size: 14px; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-green { background: #166534; color: #86efac; }
        .badge-red { background: #7f1d1d; color: #fca5a5; }
        .badge-blue { background: #1e40af; color: #93c5fd; }
        .nav { display: flex; gap: 8px; margin-bottom: 24px; }
        .nav button {
            padding: 10px 20px;
            background: #334155;
            border: none;
            border-radius: 8px;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .nav button:hover { background: #475569; }
        .nav button.active { background: #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #error-message {
            background: #7f1d1d;
            color: #fca5a5;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover { background: #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Bifrost Server</h1>
                <p style="color: #64748b; font-size: 14px; margin-top: 4px;" id="version">Loading...</p>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <span id="status-badge" class="status-badge status-healthy">Healthy</span>
                <button class="refresh-btn" onclick="refreshData()">Refresh</button>
            </div>
        </header>

        <div id="error-message"></div>

        <nav class="nav">
            <button class="active" onclick="showTab('dashboard')">Dashboard</button>
            <button onclick="showTab('backends')">Backends</button>
            <button onclick="showTab('stats')">Statistics</button>
        </nav>

        <div id="dashboard" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>Active Connections</h3>
                    <div class="value" id="active-connections">-</div>
                </div>
                <div class="card">
                    <h3>Total Connections</h3>
                    <div class="value" id="total-connections">-</div>
                </div>
                <div class="card">
                    <h3>Backends</h3>
                    <div class="value" id="backend-count">-</div>
                    <div class="subtext" id="healthy-backends">- healthy</div>
                </div>
                <div class="card">
                    <h3>Uptime</h3>
                    <div class="value" id="uptime">-</div>
                </div>
            </div>
        </div>

        <div id="backends" class="tab-content">
            <div class="section">
                <h2 class="section-title">Backends</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Active Conn</th>
                                <th>Total Conn</th>
                                <th>Bytes Sent</th>
                                <th>Bytes Recv</th>
                            </tr>
                        </thead>
                        <tbody id="backends-table">
                            <tr><td colspan="7" style="text-align: center; color: #64748b;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="stats" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>HTTP Requests</h3>
                    <div class="value" id="http-requests">-</div>
                </div>
                <div class="card">
                    <h3>SOCKS5 Requests</h3>
                    <div class="value" id="socks5-requests">-</div>
                </div>
                <div class="card">
                    <h3>Bytes Sent</h3>
                    <div class="value" id="bytes-sent">-</div>
                </div>
                <div class="card">
                    <h3>Bytes Received</h3>
                    <div class="value" id="bytes-received">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/v1';
        let refreshInterval;

        async function fetchJSON(path) {
            const resp = await fetch(API_BASE + path);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            return resp.json();
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        async function refreshData() {
            try {
                // Fetch status
                const status = await fetchJSON('/status');
                document.getElementById('version').textContent = `v${status.version || 'unknown'}`;

                const badge = document.getElementById('status-badge');
                if (status.status === 'running') {
                    badge.className = 'status-badge status-healthy';
                    badge.textContent = 'Running';
                } else {
                    badge.className = 'status-badge status-unhealthy';
                    badge.textContent = status.status;
                }

                // Fetch backends
                const backends = await fetchJSON('/backends');
                document.getElementById('backend-count').textContent = backends.length;

                let healthy = 0;
                let totalActive = 0;
                let totalConn = 0;
                let totalSent = 0;
                let totalRecv = 0;

                const tableBody = document.getElementById('backends-table');
                tableBody.innerHTML = '';

                backends.forEach(b => {
                    if (b.healthy) healthy++;
                    const stats = b.stats || {};
                    totalActive += stats.active_connections || 0;
                    totalConn += stats.total_connections || 0;
                    totalSent += stats.bytes_sent || 0;
                    totalRecv += stats.bytes_received || 0;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${b.name}</td>
                        <td><span class="badge badge-blue">${b.type}</span></td>
                        <td><span class="badge ${b.healthy ? 'badge-green' : 'badge-red'}">${b.healthy ? 'Healthy' : 'Unhealthy'}</span></td>
                        <td>${stats.active_connections || 0}</td>
                        <td>${stats.total_connections || 0}</td>
                        <td>${formatBytes(stats.bytes_sent || 0)}</td>
                        <td>${formatBytes(stats.bytes_received || 0)}</td>
                    `;
                    tableBody.appendChild(row);
                });

                document.getElementById('healthy-backends').textContent = `${healthy} healthy`;
                document.getElementById('active-connections').textContent = totalActive;
                document.getElementById('total-connections').textContent = totalConn;
                document.getElementById('bytes-sent').textContent = formatBytes(totalSent);
                document.getElementById('bytes-received').textContent = formatBytes(totalRecv);

                document.getElementById('error-message').style.display = 'none';
            } catch (err) {
                document.getElementById('error-message').textContent = 'Failed to fetch data: ' + err.message;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Initial load and refresh
        refreshData();
        refreshInterval = setInterval(refreshData, 5000);
    </script>
</body>
</html>
